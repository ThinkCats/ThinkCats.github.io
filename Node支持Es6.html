<!DOCTYPE html>
<html lang="en">
<head>
<!--  3 22, 2023 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NodeJs 支持Es6</title>
<meta name="author" content="HeHe" />
<meta name="keywords" content="nodejs" />
<meta name="generator" content="Org Mode" />
<link rel='icon' type='image/x-icon' href='/images/favicon.ico'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet' href='https://code.cdn.mozilla.net/fonts/fira.css'>
<link rel='stylesheet' href='/css/site.css?v=2' type='text/css'/>
<link rel='stylesheet' href='/css/custom.css' type='text/css'/>
<link rel='stylesheet' href='/css/syntax-coloring.css' type='text/css'/>
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="/"> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><header id="top" class="status">

 <!-- <div class='intro'>
 <img src='/images/about/profile.png' alt='ThinkCat' class='no-border'/>
<h3>ThinkCat</h3>
 <p>一个简单的开发者</p> 
</div>
-->

<div class='nav'>
<ul>
<li><b> ThinkCat </b> </li>
<li>&nbsp;&nbsp;</li>
<li><a href='/'>Blog</a>.</li>
<li><a href='/about/'>About</a></li>
</ul>
</div>
</header>
<main id="content" class="content">
<header>
<h1 class="title">NodeJs 支持Es6</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org8b52ccf">1. 使用mjs文件扩展名</a></li>
<li><a href="#org78b4f71">2. 使用loader</a></li>
</ul>
</div>
</nav>
<p>
Node10现在是最新版本,es6也是可以支持了.
</p>

<!- more -->

<section id="outline-container-org8b52ccf" class="outline-2">
<h2 id="org8b52ccf">1. 使用mjs文件扩展名</h2>
<div class="outline-text-2" id="text-org8b52ccf">
<p>
js文件以mjs作为扩展名的话，可以这样来直接执行：
</p>
<div class="org-src-container">
<pre class="src src-shell">node --experimental-modules xxxx.mjs
</pre>
</div>

<p>
这种方式比较麻烦，毕竟每个文件都要以mjs结尾。同时导致很多编辑器对mjs识别有问题。
</p>
</div>
</section>

<section id="outline-container-org78b4f71" class="outline-2">
<h2 id="org78b4f71">2. 使用loader</h2>
<div class="outline-text-2" id="text-org78b4f71">
<p>
命令格式如下:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-variable-name">NODE_OPTIONS</span>=<span class="org-string">'--experimental-modules --loader ./loader.mjs'</span> node x.js
</pre>
</div>
<p>
这样的话，只要定义一个mjs的loader就好了。
官方给的有一个loader的示例，还是好用的。
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span class="org-keyword">import</span> path from <span class="org-string">'path'</span>;
<span class="org-keyword">import</span> process from <span class="org-string">'process'</span>;
<span class="org-keyword">import</span> Module from <span class="org-string">'module'</span>;

<span class="org-keyword">const</span> <span class="org-variable-name">builtins</span> = Module.builtinModules;
<span class="org-keyword">const</span> <span class="org-variable-name">JS_EXTENSIONS</span> = <span class="org-keyword">new</span> <span class="org-type">Set</span>([<span class="org-string">'.js'</span>, <span class="org-string">'.mjs'</span>]);

<span class="org-keyword">const</span> <span class="org-variable-name">baseURL</span> = <span class="org-keyword">new</span> <span class="org-type">URL</span>(<span class="org-string">'file://'</span>);
baseURL.pathname = <span class="org-string">`${process.cwd()}/`</span>;

<span class="org-keyword">export</span> <span class="org-keyword">function</span> resolve(<span class="org-variable-name">specifier</span>, <span class="org-variable-name">parentModuleURL</span> = <span class="org-variable-name">baseURL</span>, <span class="org-variable-name">defaultResolve</span>) {
  <span class="org-keyword">if</span> (builtins.includes(specifier)) {
    <span class="org-keyword">return</span> {
      url: specifier,
      format: <span class="org-string">'builtin'</span>
    };
  }
  <span class="org-keyword">if</span> (<span class="org-string">/^\.{0,2}[/]/</span>.test(specifier) !== <span class="org-constant">true</span> &amp;&amp; !specifier.startsWith(<span class="org-string">'file:'</span>)) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">For node_modules support:</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">return defaultResolve(specifier, parentModuleURL);</span>
    <span class="org-keyword">throw</span> <span class="org-keyword">new</span> <span class="org-type">Error</span>(
      <span class="org-string">`imports must begin with '/', './', or '../'; '${specifier}' does not`</span>);
  }
  <span class="org-keyword">const</span> <span class="org-variable-name">resolved</span> = <span class="org-keyword">new</span> <span class="org-type">URL</span>(specifier, parentModuleURL);
  <span class="org-keyword">const</span> <span class="org-variable-name">ext</span> = path.extname(resolved.pathname);
  <span class="org-keyword">if</span> (!JS_EXTENSIONS.has(ext)) {
    <span class="org-keyword">throw</span> <span class="org-keyword">new</span> <span class="org-type">Error</span>(
      <span class="org-string">`Cannot load file with non-JavaScript file extension ${ext}.`</span>);
  }
  <span class="org-keyword">return</span> {
    url: resolved.href,
    format: <span class="org-string">'esm'</span>
  };
}
</pre>
</div>

<p>
这样创建了一个loader,暂且命名为: loader.mjs.
为了每次命令不用加这个mjs，可以把NODE<sub>OPTIONS设置到环境变量中去</sub>。
比如当前我用的fish shell里，可以这样设置:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">set</span> NODE_OPTIONS <span class="org-string">'--experimental-modules  --loader YOUR_PATH/loader.mjs'</span>
</pre>
</div>

<p>
bash-shell里面，这样设置:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> NODE_OPTIONS =<span class="org-string">'--experimental-modules  --loader YOUR_PATH/loader.mjs'</span>
</pre>
</div>

<p>
然后再执行es6语法的js文件的时候，就可以直接: node xxx.js了。
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<div class='footer'>
Copyright © 2020 <a href='mailto:juepei123@gmail.com'>ThinkCat</a><br>
Last updated on  7 22, 2022 using <a href="https://www.gnu.org/software/emacs/">Emacs</a> 28.2 (<a href="https://orgmode.org">Org</a> mode 9.5.5)
</div>
</footer>
</body>
</html>
