<!DOCTYPE html>
<html lang="en">
<head>
<!--  5 04, 2020 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NodeJs 支持Es6</title>
<meta name="generator" content="Org mode">
<meta name="author" content="wanglei">
<meta name="keywords" content="nodejs">
<link rel='icon' type='image/x-icon' href='/images/favicon.ico'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet' href='https://code.cdn.mozilla.net/fonts/fira.css'>
<link rel='stylesheet' href='/css/site.css?v=2' type='text/css'/>
<link rel='stylesheet' href='/css/custom.css' type='text/css'/>
<link rel='stylesheet' href='/css/syntax-coloring.css' type='text/css'/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="/"> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><header id="top" class="status">

 <!-- <div class='intro'>
 <img src='/images/about/profile.png' alt='ThinkCat' class='no-border'/>
<h3>ThinkCat</h3>
 <p>一个简单的开发者</p> 
</div>
-->

<div class='nav'>
<ul>
<li><b> ThinkCat </b> </li>
<li>&nbsp;&nbsp;</li>
<li><a href='/'>Blog</a>.</li>
<li><a href='/about/'>About</a></li>
</ul>
</div>
</header>
<main id="content">
<header>
<h1 class="title">NodeJs 支持Es6</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6663562">1. 使用mjs文件扩展名</a></li>
<li><a href="#org82e67a9">2. 使用loader</a></li>
</ul>
</div>
</nav>
<p>
Node10现在是最新版本,es6也是可以支持了.
</p>

<!- more -->

<section id="outline-container-org6663562" class="outline-2">
<h2 id="org6663562">1. 使用mjs文件扩展名</h2>
<div class="outline-text-2" id="text-org6663562">
<p>
js文件以mjs作为扩展名的话，可以这样来直接执行：
</p>
<div class="org-src-container">
<pre class="src src-shell">node --experimental-modules xxxx.mjs
</pre>
</div>

<p>
这种方式比较麻烦，毕竟每个文件都要以mjs结尾。同时导致很多编辑器对mjs识别有问题。
</p>
</div>
</section>

<section id="outline-container-org82e67a9" class="outline-2">
<h2 id="org82e67a9">2. 使用loader</h2>
<div class="outline-text-2" id="text-org82e67a9">
<p>
命令格式如下:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-variable-name">NODE_OPTIONS</span>=<span class="org-string">'--experimental-modules --loader ./loader.mjs'</span> node x.js
</pre>
</div>
<p>
这样的话，只要定义一个mjs的loader就好了。
官方给的有一个loader的示例，还是好用的。
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span class="org-keyword">import</span> path from <span class="org-string">'path'</span>;
<span class="org-keyword">import</span> process from <span class="org-string">'process'</span>;
<span class="org-keyword">import</span> Module from <span class="org-string">'module'</span>;

<span class="org-keyword">const</span> <span class="org-variable-name">builtins</span> = Module.builtinModules;
<span class="org-keyword">const</span> <span class="org-variable-name">JS_EXTENSIONS</span> = <span class="org-keyword">new</span> <span class="org-type">Set</span>([<span class="org-string">'.js'</span>, <span class="org-string">'.mjs'</span>]);

<span class="org-keyword">const</span> <span class="org-variable-name">baseURL</span> = <span class="org-keyword">new</span> <span class="org-type">URL</span>(<span class="org-string">'file://'</span>);
baseURL.pathname = <span class="org-string">`${process.cwd()}/`</span>;

<span class="org-keyword">export</span> <span class="org-keyword">function</span> resolve(<span class="org-variable-name">specifier</span>, <span class="org-variable-name">parentModuleURL</span> = <span class="org-variable-name">baseURL</span>, <span class="org-variable-name">defaultResolve</span>) {
  <span class="org-keyword">if</span> (builtins.includes(specifier)) {
    <span class="org-keyword">return</span> {
      url: specifier,
      format: <span class="org-string">'builtin'</span>
    };
  }
  <span class="org-keyword">if</span> (<span class="org-string">/^\.{0,2}[/]/</span>.test(specifier) !== <span class="org-constant">true</span> &amp;&amp; !specifier.startsWith(<span class="org-string">'file:'</span>)) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">For node_modules support:</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">return defaultResolve(specifier, parentModuleURL);</span>
    <span class="org-keyword">throw</span> <span class="org-keyword">new</span> <span class="org-type">Error</span>(
      <span class="org-string">`imports must begin with '/', './', or '../'; '${specifier}' does not`</span>);
  }
  <span class="org-keyword">const</span> <span class="org-variable-name">resolved</span> = <span class="org-keyword">new</span> <span class="org-type">URL</span>(specifier, parentModuleURL);
  <span class="org-keyword">const</span> <span class="org-variable-name">ext</span> = path.extname(resolved.pathname);
  <span class="org-keyword">if</span> (!JS_EXTENSIONS.has(ext)) {
    <span class="org-keyword">throw</span> <span class="org-keyword">new</span> <span class="org-type">Error</span>(
      <span class="org-string">`Cannot load file with non-JavaScript file extension ${ext}.`</span>);
  }
  <span class="org-keyword">return</span> {
    url: resolved.href,
    format: <span class="org-string">'esm'</span>
  };
}
</pre>
</div>

<p>
这样创建了一个loader,暂且命名为: loader.mjs.
为了每次命令不用加这个mjs，可以把NODE<sub>OPTIONS设置到环境变量中去</sub>。
比如当前我用的fish shell里，可以这样设置:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">set</span> NODE_OPTIONS <span class="org-string">'--experimental-modules  --loader YOUR_PATH/loader.mjs'</span>
</pre>
</div>

<p>
bash-shell里面，这样设置:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">NODE_OPTIONS</span> =<span class="org-string">'--experimental-modules  --loader YOUR_PATH/loader.mjs'</span>
</pre>
</div>

<p>
然后再执行es6语法的js文件的时候，就可以直接: node xxx.js了。
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<div class='footer'>
Copyright © 2020 <a href='mailto:juepei123@gmail.com'>ThinkCat</a><br>
Last updated on  5 04, 2020 using <a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.3.6)
</div>
</footer>
</body>
</html>
